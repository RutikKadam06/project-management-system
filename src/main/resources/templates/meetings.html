<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Meetings - Project Management System</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
</head>
<body>
    <nav>
        <h1>Project Management System</h1>
        <div>
            <span th:text="${user.fullName}"></span>
            <a th:href="@{/dashboard}">Dashboard</a>
            <a th:href="@{/projects}">Projects</a>
            <a th:href="@{/meetings}">Meetings</a>
            <a th:href="@{/logout}">Logout</a>
        </div>
    </nav>

    <div class="container">
        <div class="main-content" style="width: 100%;">
            <div class="header-actions">
                <h2>Meeting Calendar</h2>
                <button class="btn" onclick="openMeetingModal()">+ Schedule Meeting</button>
            </div>

            <div id="calendar" style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"></div>
        </div>
    </div>

    <!-- Meeting Modal -->
    <div id="meetingModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; overflow-y: auto; padding: 1rem;">
        <div class="form-container" style="max-width: 600px; width: 100%; margin: auto; max-height: 90vh; overflow-y: auto;">
            <h2 id="modalTitle">Schedule Meeting</h2>
            <form id="meetingForm">
                <input type="hidden" id="meetingId">
                
                <label>Meeting Title *</label>
                <input type="text" id="title" required placeholder="e.g., Sprint Planning Meeting">
                
                <label>Description</label>
                <textarea id="description" rows="3" placeholder="Enter meeting agenda and details..."></textarea>
                
                <div style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
                    <div>
                        <label>Start Date & Time *</label>
                        <input type="datetime-local" id="startTime" required>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label>Duration (minutes) *</label>
                        <input type="number" id="duration" value="60" required min="15" max="480">
                    </div>
                    <div>
                        <label>Location</label>
                        <input type="text" id="location" placeholder="Conference Room A">
                    </div>
                </div>
                
                <label>Meeting Link (Zoom/Google Meet)</label>
                <input type="url" id="meetingLink" placeholder="https://zoom.us/j/...">
                
                <label>Project</label>
                <select id="project">
                    <option value="">Select Project (Optional)</option>
                    <option th:each="proj : ${projects}" th:value="${proj.id}" th:text="${proj.name}"></option>
                </select>
                
                <label>Participants *</label>
                <select id="participants" multiple style="height: 120px;">
                    <option th:each="u : ${users}" th:value="${u.id}" th:text="${u.fullName}"></option>
                </select>
                <small style="color: #666; font-size: 0.85rem;">Hold Ctrl/Cmd to select multiple</small>
                
                <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn" style="flex: 1; min-width: 120px;">Save Meeting</button>
                    <button type="button" class="btn" onclick="closeMeetingModal()" style="flex: 1; min-width: 120px; background: #95a5a6;">Cancel</button>
                    <button type="button" id="deleteBtn" class="btn" onclick="deleteMeeting()" style="flex: 1; min-width: 120px; background: #e74c3c; display: none;">Delete</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let calendar;
        
        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('calendar');
            
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                editable: true,
                selectable: true,
                selectMirror: true,
                dayMaxEvents: true,
                select: function(info) {
                    openMeetingModal(info.startStr);
                },
                eventClick: function(info) {
                    editMeeting(info.event.id);
                },
                events: function(info, successCallback, failureCallback) {
                    fetch('/meetings/api/all')
                        .then(response => response.json())
                        .then(data => {
                            const events = data.map(meeting => ({
                                id: meeting.id,
                                title: meeting.title,
                                start: meeting.startTime,
                                end: meeting.endTime,
                                backgroundColor: '#3788d8',
                                borderColor: '#3788d8'
                            }));
                            successCallback(events);
                        })
                        .catch(error => {
                            console.error('Error loading meetings:', error);
                            failureCallback(error);
                        });
                }
            });
            
            calendar.render();
        });
        
        function openMeetingModal(startDate = null) {
            document.getElementById('meetingModal').style.display = 'flex';
            document.getElementById('modalTitle').textContent = 'Schedule Meeting';
            document.getElementById('meetingForm').reset();
            document.getElementById('meetingId').value = '';
            document.getElementById('deleteBtn').style.display = 'none';
            
            if (startDate) {
                document.getElementById('startTime').value = startDate.substring(0, 16);
            }
        }
        
        function closeMeetingModal() {
            document.getElementById('meetingModal').style.display = 'none';
        }
        
        function editMeeting(id) {
            fetch(`/meetings/api/${id}`)
                .then(response => response.json())
                .then(meeting => {
                    document.getElementById('meetingModal').style.display = 'flex';
                    document.getElementById('modalTitle').textContent = 'Edit Meeting';
                    document.getElementById('meetingId').value = meeting.id;
                    document.getElementById('title').value = meeting.title;
                    document.getElementById('description').value = meeting.description || '';
                    document.getElementById('startTime').value = meeting.startTime.substring(0, 16);
                    document.getElementById('duration').value = meeting.duration;
                    document.getElementById('meetingLink').value = meeting.meetingLink || '';
                    document.getElementById('location').value = meeting.location || '';
                    document.getElementById('project').value = meeting.project?.id || '';
                    
                    const participantIds = meeting.participants.map(p => p.id);
                    Array.from(document.getElementById('participants').options).forEach(option => {
                        option.selected = participantIds.includes(option.value);
                    });
                    
                    document.getElementById('deleteBtn').style.display = 'block';
                });
        }
        
        document.getElementById('meetingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const id = document.getElementById('meetingId').value;
            const startTime = document.getElementById('startTime').value;
            const duration = parseInt(document.getElementById('duration').value);
            const endTime = new Date(new Date(startTime).getTime() + duration * 60000).toISOString();
            
            const selectedParticipants = Array.from(document.getElementById('participants').selectedOptions)
                .map(option => ({ id: option.value }));
            
            const meeting = {
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                startTime: startTime,
                endTime: endTime,
                duration: duration,
                meetingLink: document.getElementById('meetingLink').value,
                location: document.getElementById('location').value,
                project: document.getElementById('project').value ? { id: document.getElementById('project').value } : null,
                participants: selectedParticipants
            };
            
            const url = id ? `/meetings/api/update/${id}` : '/meetings/api/create';
            const method = id ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(meeting)
            })
            .then(response => response.json())
            .then(data => {
                closeMeetingModal();
                calendar.refetchEvents();
                alert('Meeting saved successfully!');
            })
            .catch(error => {
                alert('Error saving meeting: ' + error);
            });
        });
        
        function deleteMeeting() {
            const id = document.getElementById('meetingId').value;
            if (confirm('Are you sure you want to delete this meeting?')) {
                fetch(`/meetings/api/delete/${id}`, { method: 'DELETE' })
                    .then(() => {
                        closeMeetingModal();
                        calendar.refetchEvents();
                        alert('Meeting deleted successfully!');
                    })
                    .catch(error => alert('Error deleting meeting: ' + error));
            }
        }
    </script>
</body>
</html>
